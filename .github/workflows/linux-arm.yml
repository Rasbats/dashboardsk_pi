---
# yamllint disable rule:line-length
name: Linux ARM build

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'manual/**'
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'manual/**'

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build on ${{ matrix.distro }} ${{ matrix.arch }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: aarch64
            distro: bullseye
          - arch: aarch64
            distro: buster
          - arch: armv7
            distro: bullseye
          - arch: armv7
            distro: buster

    # Use bash as the shell, even under MSW where the default is PowerShell.
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'recursive'
      - uses: uraimo/run-on-arch-action@v2
        name: Build artifact
        id: build
        with:
          arch: ${{ matrix.arch }}
          distro: ${{ matrix.distro }}
          githubToken: ${{ github.token }}
          setup: |
            mkdir -p "${PWD}/artifacts"
          dockerRunArgs: |
            --volume "${PWD}/artifacts:/artifacts"

          shell: /bin/sh

          install: |
            case "${{ matrix.distro }}" in
              ubuntu*|jessie|stretch|buster|bullseye)
                apt-get update -q -y
                apt-get install -q -y sudo
                ;;
              fedora*)
                dnf -y update
                dnf -y install sudo
                ;;
              alpine*)
                apk update
                apk add sudo
                ;;
            esac

          run: |
            ./ci/github-pre-build.sh
            cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}
            cmake --build build --config ${{env.BUILD_TYPE}}
...
